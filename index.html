<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pendaftaran Kelas CPR Hero</title>
<meta name="description" content="Daftar kelas CPR & Heimlich Maneuver dengan CPR Hero. Sijil BLS rasmi, kelas di Kuala Terengganu dan Seremban atau on-site.">
<meta property="og:title" content="Pendaftaran Kelas CPR Hero">
<meta property="og:description" content="Daftar kelas CPR & Heimlich Maneuver dengan CPR Hero">
<meta property="og:image" content="images/hero-section.webp">

<!-- META PIXEL START -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1888507002059842');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1888507002059842&ev=PageView&noscript=1"
/></noscript>
<!-- META PIXEL END -->

<style>
body {
  font-family: 'Inter', sans-serif;
  background-color: #f4f7fb;
  margin: 0;
  padding: 0;
  color: #222;
}
.hero {
  width: 100%;
  text-align: center;
  background: #fff;
  padding: 20px 0;
}
.hero-images {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0;
  max-width: 800px;
  margin: 0 auto;
}
.hero-images img {
  width: 100%;
  max-width: 800px;
  height: auto;
  display: block;
  border-radius: 0;
  box-shadow: 0 8px 30px rgba(16, 24, 40, 0.08);
}
.hero-images img:not(:last-child) {
  margin-bottom: 0;
}

/* CTA Boxes - UPDATED */
.cta-box {
  max-width: 520px;
  margin: 40px auto;
  padding: 24px 32px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(37, 211, 102, 0.3);
  text-align: center;
  border: 2px solid #25d366;
  animation: pulseGlow 2s ease-in-out infinite;
}

@keyframes pulseGlow {
  0%, 100% {
    box-shadow: 0 4px 20px rgba(37, 211, 102, 0.3);
    transform: scale(1);
  }
  50% {
    box-shadow: 0 8px 35px rgba(37, 211, 102, 0.6);
    transform: scale(1.02);
  }
}

.cta-box p {
  font-size: 1.05rem;
  line-height: 1.6;
  color: #333;
  margin: 0 0 20px 0;
  font-weight: 500;
}

.cta-box-alt {
  background: #fff;
  border: 2px solid #25d366;
  box-shadow: 0 4px 20px rgba(37, 211, 102, 0.3);
  animation: none;
}

.cta-box-alt p {
  font-family: 'Georgia', 'Palatino', serif; /* CHANGED: Elegant serif font */
  font-size: 1.1rem;
  font-style: italic; /* Added italic for emphasis */
}

/* Divider Section */
.divider-section {
  max-width: 520px;
  margin: 50px auto;
  padding: 20px 32px;
  background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  border-radius: 12px;
  text-align: center;
  border-left: 5px solid #7f1d1d;
  box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
}

.divider-section p {
  font-size: 1.1rem;
  line-height: 1.7;
  color: #ffffff;
  margin: 0;
  font-weight: 600;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}

/* ADDED: Button with icon */
.btn-with-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn-with-icon::before {
  content: "ðŸ’¾";
  font-size: 1.2rem;
}

.container {
  max-width: 520px;
  margin: 40px auto;
  padding: 32px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}
h1 {
  text-align: center;
  font-size: 1.6rem;
  margin-bottom: 10px;
}
p.subtitle {
  text-align: center;
  color: #555;
  font-size: 0.95rem;
  margin-bottom: 30px;
  line-height: 1.5;
}
label {
  display: block;
  margin-top: 20px;
  font-weight: 600;
  font-size: 0.95rem;
}
input[type="text"], select, input[type="number"], textarea {
  width: 100%;
  box-sizing: border-box;
  padding: 10px 12px;
  margin-top: 6px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 0.95rem;
  outline: none;
  background-color: #fff;
  transition: border-color 0.3s ease;
  font-family: 'Inter', sans-serif;
}
input[type="text"], select, input[type="number"] {
  height: 44px;
  appearance: none;
}
textarea {
  min-height: 80px;
  resize: vertical;
}
input[type="text"]:focus, select:focus, input[type="number"]:focus, textarea:focus {
  border-color: #25d366;
}
.field-error {
  border-color: #ff3b3b !important;
  animation: shake 0.3s;
}
.field-success {
  border-color: #0a7d00 !important;
}
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-8px); }
  75% { transform: translateX(8px); }
}
select {
  background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath fill='gray' d='M0 0l5 6 5-6z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 10px;
}
.info-box {
  font-size: 13px;
  color: #333;
  margin-top: 8px;
  background: #f0f8ff;
  padding: 10px;
  border-radius: 6px;
  transition: 0.3s ease;
}
.action1 { background: #ffe5e5; border-left: 4px solid #ff3b3b; }
.action2 { background: #fff3e0; border-left: 4px solid #ff9800; }
.action3 { background: #eaffe5; border-left: 4px solid #0a7d00; }

.glow-red { animation: glowRed 1.5s infinite alternate; }
@keyframes glowRed { 0% { box-shadow: 0 0 0px rgba(255, 59, 59, 0.4); } 100% { box-shadow: 0 0 12px rgba(255, 59, 59, 0.7); } }

.glow-yellow { animation: glowYellow 1.5s infinite alternate; }
@keyframes glowYellow { 0% { box-shadow: 0 0 0px rgba(255, 152, 0, 0.4); } 100% { box-shadow: 0 0 12px rgba(255, 152, 0, 0.7); } }

.glow-green { animation: glowGreen 1.5s infinite alternate; }
@keyframes glowGreen { 0% { box-shadow: 0 0 0px rgba(0, 255, 102, 0.4); } 100% { box-shadow: 0 0 12px rgba(0, 255, 102, 0.7); } }

#estimateTitle {
  text-align: center;
  font-size: 1.1rem;
  font-weight: 700;
  margin-top: 18px;
  margin-bottom: 4px;
  display: none;
}

.estimate-wrap {
  margin-top: 12px;
  margin-bottom: 6px;
  transition: all 0.35s ease;
  text-align: center;
  line-height: 1;
}
.estimate-amount {
  display: block;
  font-weight: 700;
  font-size: 1.9rem;
  margin-top: 6px;
  margin-bottom: 4px;
  letter-spacing: 0.5px;
}
.estimate-note {
  display: block;
  font-size: 0.85rem;
  color: #555;
  margin-bottom: 8px;
}

.fade-in {
  opacity: 0;
  transform: translateY(6px);
  animation: fadeInUp 0.28s forwards;
}
@keyframes fadeInUp {
  to { opacity: 1; transform: translateY(0); }
}

button {
  margin-top: 30px;
  width: 100%;
  padding: 14px;
  font-size: 1rem;
  font-weight: 600;
  background-color: #25d366;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.2s ease;
}
button:hover {
  background-color: #1ea952;
  transform: translateY(-1px);
}
button:active {
  transform: translateY(0);
}
button:disabled {
  background-color: #ccc;
  cursor: not-allowed;
  transform: none;
}
.btn-cta {
  margin-top: 0;
}
footer.note {
  padding: 14px 18px;
  text-align: center;
  font-size: 13px;
  color: #777;
  background: #fbfdff;
  margin-top: 40px;
}
.hidden { display: none; }

/* Mobile responsive */
@media (max-width: 768px) {
  .container, .cta-box, .divider-section {
    margin: 20px;
    padding: 24px;
  }
  h1 {
    font-size: 1.4rem;
  }
  button {
    padding: 16px;
    font-size: 1.05rem;
  }
  input[type="text"], select, input[type="number"], textarea {
    font-size: 16px;
  }
  .cta-box p, .divider-section p {
    font-size: 1rem;
  }
}
</style>
</head>

<body>
<section class="hero">
  <div class="hero-images">
    <img 
      src="images/hero-section.webp" 
      alt="Banner kelas CPR Hero - Bahagian atas" 
      loading="eager"
      width="800"
      height="auto">
    <img 
      src="images/middle-section.webp" 
      alt="Banner kelas CPR Hero - Bahagian tengah" 
      loading="eager"
      width="800"
      height="auto">
    <img 
      src="images/bottom-section.webp" 
      alt="Banner kelas CPR Hero - Bahagian bawah" 
      loading="eager"
      width="800"
      height="auto">
  </div>
</section>

<!-- CTA SECTION 1: SAVE CONTACT -->
<div class="cta-box">
  <p>PERHATIAN! Jika anda hanya berminat tetapi belum mahu belajar atau ambil tindakan seperti book atau deposit, SAVE dulu contact CPR Hero. Hubungi kami bila-bila masa & dapatkan PROMO istimewa!</p>
  <button class="btn-cta btn-with-icon" onclick="saveContact()">Save Contact CPR Hero</button>
</div>

<!-- DIVIDER SECTION -->
<div class="divider-section">
  <p>dan sekarang,.. jika anda yakin dan ingin belajar, ayuh daftar FORM di bawah!.</p>
</div>

<!-- MAIN FORM CONTAINER -->
<div class="container">
<h1>Pendaftaran Kelas CPR & Heimlich Maneuver</h1>
<p class="subtitle">Isi maklumat di bawah. Selepas tekan WhatsApp, mesej pra-isian akan terbuka untuk dihantar ke CPR Hero.</p>

<!-- NAMA -->
<label for="nama">Nama</label>
<input type="text" id="nama" placeholder="Contoh: Nur" aria-required="true" />

<!-- JENIS KELAS -->
<label for="kelas">Jenis kelas</label>
<select id="kelas" aria-label="Pilih jenis kelas" aria-required="true" onchange="updateKelasInfo(); recalcAndAnimate();">
  <option value="" disabled selected>Pilih jenis kelas</option>
  <option value="Kelas Asas">Kelas Asas</option>
  <option value="Kelas Lengkap">Kelas Lengkap</option>
</select>
<div id="kelasInfo" class="info-box hidden"></div>

<!-- LOKASI -->
<label for="lokasi">Lokasi kelas</label>
<select id="lokasi" aria-label="Pilih lokasi kelas" aria-required="true" onchange="updateLokasiInfo(); recalcAndAnimate();">
  <option value="" disabled selected>Pilih lokasi</option>
  <option value="Kuala Terengganu">Kuala Terengganu</option>
  <option value="Seremban">Seremban</option>
  <option value="On-site di tempat anda">On-site (kami datang ke lokasi anda)</option>
</select>
<div id="lokasiInfo" class="info-box hidden"></div>

<!-- PESERTA -->
<label for="jumlah">Anggaran jumlah peserta</label>
<input type="number" id="jumlah" value="1" min="1" aria-required="true" onchange="recalcAndAnimate();" oninput="recalcAndAnimate();" />

<!-- TARIKH -->
<label>Cadangan tarikh (bulan & tahun)</label>
<div style="display: flex; gap: 10px;">
  <select id="bulan" aria-label="Pilih bulan" aria-required="true" onchange="recalcAndAnimate();">
    <option value="" disabled selected>Bulan</option>
    <option>Januari</option><option>Februari</option><option>Mac</option>
    <option>April</option><option>Mei</option><option>Jun</option>
    <option>Julai</option><option>Ogos</option><option>September</option>
    <option>Oktober</option><option>November</option><option>Disember</option>
  </select>

  <select id="tahun" aria-label="Pilih tahun" aria-required="true" onchange="recalcAndAnimate();">
    <option value="" disabled selected>Tahun</option>
    <option>2025</option><option>2026</option>
  </select>
</div>

<!-- ESTIMATE -->
<div id="estimateTitle">Anggaran Harga Yuran</div>

<div id="estimateArea" class="estimate-wrap" aria-live="polite">
  <span id="estimateAmount" class="estimate-amount" style="display:none;">RM0.00</span>
  <span id="estimateNote" class="estimate-note" style="display:none;">(Sila lengkapkan pilihan untuk lihat anggaran)</span>
</div>

<!-- PILIH TINDAKAN SETERUSNYA -->
<label for="action">Pilih tindakan seterusnya</label>
<select id="action" aria-label="Pilih tindakan seterusnya" aria-required="true" onchange="highlightAction()">
  <option value="" disabled selected>Pilih tindakan</option>
  <option value="1">ðŸ”´ Saya nak tanya detail sebelum confirm deposit</option>
  <option value="2">ðŸŸ¡ Saya nak semak slot & buat deposit</option>
  <option value="3">ðŸŸ¢ Saya nak booking & bayar penuh sekarang</option>
</select>
<div id="actionMsg" class="info-box hidden"></div>

<!-- SOALAN (CONDITIONAL) -->
<div id="soalanContainer" class="hidden">
  <label for="soalan">Soalan anda (pilihan)</label>
  <textarea id="soalan" placeholder="Contoh: Ada Special Price tak kalau ramai? Ada Referral Reward: Yuran percuma untuk introducer tak?"></textarea>
</div>

<button id="submitBtn" onclick="hantarWhatsApp()">WhatsApp ke CPR Hero!</button>
</div>

<!-- CTA SECTION 2: HARGA RAMAI-RAMAI -->
<div class="cta-box cta-box-alt">
  <p>Psstt! Anda nak ajak company/tadika/pusat dialisis/staff belajar CPR ramai-ramai? Kami ada harga khas untuk itu. WhatsApp kami untuk harga RAMAI2!</p>
  <button class="btn-cta" onclick="hargaRamai()">Nak Harga Ramai-Ramai!</button>
</div>

<footer class="note">Form by CPR Hero</footer>

<script>
    // =================== NEW: SAVE CONTACT FUNCTION ===================
function saveContact() {
  try {
    const mesej = "Saya save dulu contact CPR Hero di sini ya!";
    const url = "https://wa.me/601114160068?text=" + encodeURIComponent(mesej);
    
    // Fire Facebook Pixel Lead event
    setTimeout(function() {
      if (typeof fbq !== 'undefined') {
        fbq('track', 'Lead', {
          content_name: 'Save Contact',
          content_category: 'Lead Capture'
        });
      }
    }, 600);
    
    window.open(url, "_blank");
  } catch (error) {
    console.error("Error:", error);
    alert("Maaf, ada masalah teknikal. Sila cuba lagi atau hubungi kami terus.");
  }
}

// =================== NEW: HARGA RAMAI FUNCTION ===================
function hargaRamai() {
  try {
    const mesej = "Saya nak harga RAMAI2!";
    const url = "https://wa.me/601114160068?text=" + encodeURIComponent(mesej);
    
    // Fire Facebook Pixel Lead event
    setTimeout(function() {
      if (typeof fbq !== 'undefined') {
        fbq('track', 'Lead', {
          content_name: 'Harga Ramai-Ramai',
          content_category: 'Group Booking'
        });
      }
    }, 600);
    
    window.open(url, "_blank");
  } catch (error) {
    console.error("Error:", error);
    alert("Maaf, ada masalah teknikal. Sila cuba lagi atau hubungi kami terus.");
  }
}

// =================== UTILITY: SANITIZE INPUT ===================
function sanitizeInput(str) {
  return str.trim().replace(/[<>]/g, '');
}

// =================== UTILITY: VALIDATE FIELD ===================
function validateField(fieldId) {
  const field = document.getElementById(fieldId);
  const value = field.value.trim();
  
  if (!value) {
    field.classList.add('field-error');
    field.classList.remove('field-success');
    return false;
  }
  
  field.classList.remove('field-error');
  field.classList.add('field-success');
  return true;
}

// =================== KELAS ===================
function updateKelasInfo() {
  const box = document.getElementById("kelasInfo");
  const val = document.getElementById("kelas").value;

  if (!val) return box.classList.add("hidden");

  box.classList.remove("hidden");

  box.textContent =
    val === "Kelas Asas"
      ? "Teori dan demo selama 4 jam â€“ peserta akan menerima sijil penyertaan."
      : "Teori, praktikal dan ujian selama 6 jam â€“ peserta menerima sijil dan kad BLS rasmi.";
}

// =================== LOKASI ===================
function updateLokasiInfo() {
  const box = document.getElementById("lokasiInfo");
  const val = document.getElementById("lokasi").value;

  if (!val) return box.classList.add("hidden");

  box.classList.remove("hidden");

  if (val === "Kuala Terengganu") {
    box.textContent = "Di premis CPR Hero (di Kuala Nerus).";
  } else if (val === "Seremban") {
    box.textContent = "Di premis CPR Hero (di Seremban 2).";
  } else {
    box.textContent = "Trainer akan datang ke lokasi anda. Sesuai dianjurkan oleh organisasi, taska, pejabat dan event. Bergantung kesesuaian lokasi.";
  }
}

// =================== ACTION ===================
function highlightAction() {
  const action = document.getElementById("action").value;
  const msg = document.getElementById("actionMsg");
  const soalanContainer = document.getElementById("soalanContainer");

  msg.className = "info-box";
  msg.classList.remove("hidden");
  msg.classList.remove("action1","action2","action3","glow-red","glow-yellow","glow-green");

  if (action === "1") {
    soalanContainer.classList.remove("hidden");
    msg.classList.add("action1","glow-red");
  } else {
    soalanContainer.classList.add("hidden");
    document.getElementById("soalan").value = "";
  }

  if (action === "2") msg.classList.add("action2","glow-yellow");
  if (action === "3") msg.classList.add("action3","glow-green");

  const teks = {
    1:"Hantar mesej auto dengan nama, kelas, tarikh cadangan & soalan anda.",
    2:"Kami akan hubungi anda untuk confirm slot dan hantar link deposit.",
    3:"Secure tempat anda terus tanpa tunggu."
  };
  msg.textContent = teks[action];
}

// =================== PRICE LOGIC ===================
const PRICES = {
  "Kelas Asas": 250,
  "Kelas Lengkap": 350
};

function locationExtraPerPax(locVal) {
  if (!locVal) return 0;
  if (locVal === "Kuala Terengganu") return 0;
  if (locVal === "Seremban") return 100;
  return 100;
}

function computeTotal() {
  const kelas = document.getElementById("kelas").value;
  const lokasi = document.getElementById("lokasi").value;
  let jumlah = parseInt(document.getElementById("jumlah").value, 10);
  if (isNaN(jumlah) || jumlah < 1) jumlah = 1;

  const base = PRICES[kelas] || 0;
  const extra = locationExtraPerPax(lokasi);

  return (base + extra) * jumlah;
}

// =================== MASK & SPELLING ===================
function maskAmount(total) {
  const n = Math.max(0, Math.round(total));
  if (n >= 1000) {
    const leading = Math.floor(n / 1000);
    return `RM${leading}XXX.XX`;
  } else if (n >= 100) {
    const leading = Math.floor(n / 100);
    return `RM${leading}XX.XX`;
  } else {
    const leading = Math.floor(n / 10);
    return `RM${leading}X.XX`;
  }
}

function onesWord(i) {
  const map = ["Kosong","Satu","Dua","Tiga","Empat","Lima","Enam","Tujuh","Lapan","Sembilan"];
  return map[i] || String(i);
}
function teensWord(n) {
  const map = {
    10:"Sepuluh",11:"Sebelas",12:"Dua Belas",13:"Tiga Belas",14:"Empat Belas",
    15:"Lima Belas",16:"Enam Belas",17:"Tujuh Belas",18:"Lapan Belas",19:"Sembilan Belas"
  };
  return map[n] || String(n);
}
function tensWord(tens) {
  const map = {
    10: "Sepuluh", 20: "Dua Puluh", 30: "Tiga Puluh", 40: "Empat Puluh",
    50: "Lima Puluh", 60: "Enam Puluh", 70: "Tujuh Puluh", 80: "Lapan Puluh", 90: "Sembilan Puluh"
  };
  return map[tens] || String(tens);
}
function threeDigitsToMalay(n) {
  n = Math.max(0, Math.min(999, Math.floor(n)));
  const h = Math.floor(n / 100);
  const rem = n % 100;
  let parts = [];

  if (h > 0) {
    if (h === 1) parts.push("Seratus");
    else parts.push(onesWord(h) + " Ratus");
  }

  if (rem > 0) {
    if (rem < 10) {
      parts.push(onesWord(rem));
    } else if (rem >= 10 && rem < 20) {
      parts.push(teensWord(rem));
    } else {
      const t = Math.floor(rem / 10) * 10;
      const o = rem % 10;
      parts.push(tensWord(t));
      if (o > 0) parts.push(onesWord(o));
    }
  }

  return parts.join(" ");
}

function categoryText(total) {
  const n = Math.max(0, Math.round(total));
  if (n === 0) return "(Sila lengkapkan pilihan untuk lihat anggaran)";
  if (n < 10) return "(Kurang dari Sepuluh Ringgit)";

  if (n >= 10 && n < 100) {
    const tens = Math.floor(n / 10) * 10;
    return `(Lebih kurang dalam ${tensWord(tens)} Ringgit)`;
  }

  if (n >= 100 && n < 1000) {
    const hundredsDigit = Math.floor(n / 100);
    const hundredsText = (hundredsDigit === 1) ? "Seratus" : onesWord(hundredsDigit) + " Ratus";
    return `(Lebih kurang dalam ${hundredsText} Ringgit)`;
  }

  if (n >= 1000 && n < 100000) {
    const thousands = Math.floor(n / 1000);
    const thouText = threeDigitsToMalay(thousands);
    return `(Lebih kurang dalam ${thouText} Ribu Ringgit)`;
  }

  if (n >= 100000 && n < 1000000) {
    const thousands = Math.floor(n / 1000);
    const truncatedThousands = Math.floor(thousands / 10) * 10;
    const text = threeDigitsToMalay(truncatedThousands);
    return `(Lebih kurang dalam ${text} Ribu Ringgit)`;
  }

  if (n >= 1000000) {
    const millions = Math.floor(n / 1000000);
    const millionsText = threeDigitsToMalay(millions);
    return `(Lebih kurang dalam ${millionsText} Juta Ringgit)`;
  }

  return "(Sila lengkapkan pilihan untuk lihat anggaran)";
}

// =================== COUNTER ANIMATION ===================
let currentDisplayedValue = 0;
let animFrame = null;

function animateTo(target, duration = 1000) {
  cancelAnimation();
  const start = performance.now();
  const from = currentDisplayedValue || 0;
  function step(ts) {
    const elapsed = ts - start;
    const t = Math.min(1, elapsed / duration);
    const ease = 1 - (1 - t) * (1 - t);
    const val = Math.round(from + (target - from) * ease);
    currentDisplayedValue = val;
    updateEstimateDisplayMasked(val);
    if (t < 1) {
      animFrame = requestAnimationFrame(step);
    } else {
      animFrame = null;
      currentDisplayedValue = target;
      updateEstimateDisplayMasked(target);
    }
  }
  animFrame = requestAnimationFrame(step);
}

function cancelAnimation() {
  if (animFrame) {
    cancelAnimationFrame(animFrame);
    animFrame = null;
  }
}

function updateEstimateDisplayMasked(numericValue) {
  const titleEl = document.getElementById("estimateTitle");
  const amountEl = document.getElementById("estimateAmount");
  const noteEl = document.getElementById("estimateNote");

  if (amountEl.style.display === "none") {
    amountEl.style.display = "block";
    amountEl.classList.add("fade-in");
  } else {
    amountEl.classList.remove("fade-in");
    void amountEl.offsetWidth;
    amountEl.classList.add("fade-in");
  }
  if (noteEl.style.display === "none") {
    noteEl.style.display = "block";
    noteEl.classList.add("fade-in");
  } else {
    noteEl.classList.remove("fade-in");
    void noteEl.offsetWidth;
    noteEl.classList.add("fade-in");
  }

  if (titleEl.style.display === "none") {
    titleEl.style.display = "block";
    titleEl.classList.add("fade-in");
  }

  amountEl.textContent = maskAmount(numericValue);
  noteEl.textContent = categoryText(numericValue);
}

function recalcAndAnimate() {
  const nameVal = document.getElementById("nama").value.trim();
  const amountEl = document.getElementById("estimateAmount");
  const noteEl = document.getElementById("estimateNote");
  const titleEl = document.getElementById("estimateTitle");

  if (!nameVal) {
    amountEl.style.display = "none";
    noteEl.style.display = "none";
    titleEl.style.display = "none";
    currentDisplayedValue = 0;
    cancelAnimation();
    return;
  }

  const total = computeTotal();

  if (total === 0) {
    cancelAnimation();
    currentDisplayedValue = 0;
    amountEl.style.display = "block";
    amountEl.classList.add("fade-in");
    amountEl.textContent = "RM0.00";
    noteEl.style.display = "block";
    noteEl.classList.add("fade-in");
    noteEl.textContent = "(Sila lengkapkan pilihan untuk lihat anggaran)";
    titleEl.style.display = "block";
    titleEl.classList.add("fade-in");
    return;
  }

  animateTo(Math.round(total), 1000);
}

// Event listener for nama field
document.getElementById("nama").addEventListener("input", function() {
  const nameVal = this.value.trim();
  const amountEl = document.getElementById("estimateAmount");
  const noteEl = document.getElementById("estimateNote");
  const titleEl = document.getElementById("estimateTitle");
  if (nameVal) {
    if (amountEl.style.display === "none") {
      amountEl.style.display = "block";
      amountEl.classList.add("fade-in");
    }
    amountEl.textContent = "RM0.00";
    noteEl.style.display = "block";
    noteEl.classList.add("fade-in");
    noteEl.textContent = "(Sila lengkapkan pilihan untuk lihat anggaran)";
    if (titleEl.style.display === "none") {
      titleEl.style.display = "block";
      titleEl.classList.add("fade-in");
    }
    recalcAndAnimate();
  } else {
    amountEl.style.display = "none";
    noteEl.style.display = "none";
    titleEl.style.display = "none";
    cancelAnimation();
    currentDisplayedValue = 0;
  }
});

// Additional event listeners
document.getElementById("kelas").addEventListener("input", recalcAndAnimate);
document.getElementById("lokasi").addEventListener("input", recalcAndAnimate);
document.getElementById("jumlah").addEventListener("input", recalcAndAnimate);
document.getElementById("bulan").addEventListener("input", recalcAndAnimate);
document.getElementById("tahun").addEventListener("input", recalcAndAnimate);
    // =================== WHATSAPP WITH ERROR HANDLING + FB PIXEL ===================
function hantarWhatsApp() {
  try {
    // Validate all fields
    const nama = sanitizeInput(document.getElementById("nama").value);
    const kelas = document.getElementById("kelas").value;
    const lokasi = document.getElementById("lokasi").value;
    const jumlah = document.getElementById("jumlah").value;
    const bulan = document.getElementById("bulan").value;
    const tahun = document.getElementById("tahun").value;
    const action = document.getElementById("action").value;

    // Visual validation
    let allValid = true;
    allValid = validateField("nama") && allValid;
    allValid = validateField("kelas") && allValid;
    allValid = validateField("lokasi") && allValid;
    allValid = validateField("jumlah") && allValid;
    allValid = validateField("bulan") && allValid;
    allValid = validateField("tahun") && allValid;
    allValid = validateField("action") && allValid;

    if (!allValid || !nama || !kelas || !lokasi || !jumlah || !bulan || !tahun || !action) {
      alert("Sila isi semua maklumat dengan lengkap.");
      return;
    }

    // Disable button and show loading
    const btn = document.getElementById("submitBtn");
    btn.disabled = true;
    btn.textContent = "Menghantar...";

    const actionText = {
      1:"ðŸ”´ Saya nak tanya detail sebelum confirm deposit",
      2:"ðŸŸ¡ Saya nak semak slot & buat deposit",
      3:"ðŸŸ¢ Saya nak booking & bayar penuh sekarang"
    };

    let mesej =
`Hai CPR Hero ðŸ‘‹

Nama: ${nama}
Jenis Kelas: ${kelas}
Lokasi: ${lokasi}
Anggaran Peserta: ${jumlah}
Cadangan Tarikh: ${bulan} ${tahun}
Tindakan Seterusnya: ${actionText[action]}`;

    // Add soalan if action is 1
    if (action === "1") {
      const soalan = sanitizeInput(document.getElementById("soalan").value);
      if (soalan) {
        mesej += `\n\nSoalan saya: ${soalan}`;
      }
    }

    mesej += "\n\nTerima kasih.";

    const url = "https://wa.me/601114160068?text=" + encodeURIComponent(mesej);
    
    // <!-- FB LEAD EVENT BEFORE REDIRECT -->
    // Fire Facebook Pixel Lead event with 600ms delay
    setTimeout(function() {
      if (typeof fbq !== 'undefined') {
        fbq('track', 'Lead', {
          content_name: kelas,
          content_category: lokasi,
          value: jumlah,
          currency: 'MYR'
        });
      }
    }, 600);
    
    // Open WhatsApp
    const whatsappWindow = window.open(url, "_blank");
    
    // Reset button after short delay
    setTimeout(() => {
      btn.disabled = false;
      btn.textContent = "WhatsApp ke CPR Hero!";
    }, 2000);

    // Check if popup was blocked
    if (!whatsappWindow || whatsappWindow.closed || typeof whatsappWindow.closed === 'undefined') {
      alert("Popup disekat! Sila enable popup untuk browser anda.");
    }

  } catch (error) {
    console.error("Error:", error);
    alert("Maaf, ada masalah teknikal. Sila cuba lagi atau hubungi kami terus.");
    
    // Reset button on error
    const btn = document.getElementById("submitBtn");
    btn.disabled = false;
    btn.textContent = "WhatsApp ke CPR Hero!";
  }
}
</script>

</body>
</html>
